// lib/firebaseClient.js
// âœ… Final Version with Extended Debug Logs & Client/Server Detection
// Safe Firebase Client SDK initialization for Next.js 15+
// Support: Firebase v12+, Turbopack, and client-side dynamic imports

import { initializeApp, getApps, getApp } from "firebase/app";
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";

// Cached instances to prevent re-initialization
let firebaseApp = null;
let firebaseAuth = null;
let firebaseDB = null;

export async function getFirebaseClient() {
  // âœ… Kiá»ƒm tra xem Ä‘ang cháº¡y á»Ÿ client hay server
  if (typeof window === "undefined") {
    console.warn(
      "[firebaseClient] âš ï¸ Running in server context â€” Firebase Client SDK will not initialize."
    );
    return {};
  }

  // âœ… Náº¿u app Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o, tráº£ vá» ngay (trÃ¡nh lá»—i duplicate)
  if (firebaseApp && firebaseAuth && firebaseDB) {
    console.log("[firebaseClient] âš¡ Reusing existing Firebase client instance");
    return { app: firebaseApp, auth: firebaseAuth, db: firebaseDB };
  }

  console.log("[firebaseClient] âš™ï¸ Initializing Firebase client...");

  // âœ… Cáº¥u hÃ¬nh Firebase láº¥y tá»« biáº¿n mÃ´i trÆ°á»ng
  const firebaseConfig = {
    apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
    authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
    projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
    storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
    appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
  };

  // ğŸ” Log chi tiáº¿t biáº¿n mÃ´i trÆ°á»ng Ä‘á»ƒ debug
  console.log("[firebaseClient] ğŸ” Env Check:", {
    apiKey:
      firebaseConfig.apiKey && firebaseConfig.apiKey.length > 5
        ? "âœ… Loaded"
        : "âŒ Missing or too short",
    authDomain: firebaseConfig.authDomain || "âŒ Missing",
    projectId: firebaseConfig.projectId || "âŒ Missing",
    storageBucket: firebaseConfig.storageBucket || "âŒ Missing",
    appId: firebaseConfig.appId
      ? firebaseConfig.appId.slice(0, 10) + "..."
      : "âŒ Missing",
  });

  // âœ… Náº¿u Ä‘ang cháº¡y trÃªn client, hiá»ƒn thá»‹ config thá»±c táº¿ (áº©n khÃ³a nháº¡y cáº£m)
  if (typeof window !== "undefined") {
    console.log("[firebaseClient] ğŸ” Loaded config on client:", {
      projectId: firebaseConfig.projectId,
      apiKey: firebaseConfig.apiKey
        ? firebaseConfig.apiKey.slice(0, 8) + "..."
        : "âŒ Missing",
      authDomain: firebaseConfig.authDomain,
    });
  } else {
    console.log("[firebaseClient] âš ï¸ Running on server, env not available.");
  }

  // âš ï¸ Náº¿u thiáº¿u env â†’ cáº£nh bÃ¡o rÃµ rÃ ng
  if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
    console.error(
      "[firebaseClient] âŒ Missing Firebase env vars. Check your .env.local file (must start with NEXT_PUBLIC_)."
    );
  }

  // âœ… Khá»Ÿi táº¡o app an toÃ n (chá»‰ má»™t láº§n)
  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);

  // âœ… Khá»Ÿi táº¡o Auth & Firestore client
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Cache láº¡i Ä‘á»ƒ tÃ¡i sá»­ dá»¥ng
  firebaseApp = app;
  firebaseAuth = auth;
  firebaseDB = db;

  // ğŸ“¦ Log cáº¥u hÃ¬nh app thá»±c táº¿ sau khi init
  console.log("[firebaseClient] âœ… Firebase client initialized successfully");
  console.log("[firebaseClient] ğŸ§© App name:", app.name);
  console.log("[firebaseClient] ğŸ§© App options:", app.options);

  // Kiá»ƒm tra nhanh káº¿t ná»‘i Firestore (client)
  try {
    const projectId = app.options?.projectId || "(unknown)";
    console.log(`[firebaseClient] ğŸ”— Connected to project: ${projectId}`);
  } catch (err) {
    console.error("[firebaseClient] âš ï¸ Firestore connection check failed:", err);
  }

  return { app, auth, db };
}

