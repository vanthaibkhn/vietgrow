// pages/api/feedback.js (phiÃªn báº£n cuá»‘i, Ä‘á»“ng bá»™ feedbackService)
import { feedbackService } from "../../services/feedbackService.js";

export default async function handler(req, res) {
  if (req.method !== "POST")
    return res.status(405).json({ error: "Method not allowed" });

  try {
    const { questionId, feedback, note } = req.body;
    const ipHeader = req.headers["x-forwarded-for"];
    const userIp = ipHeader ? ipHeader.split(",")[0].trim() : req.socket.remoteAddress;

    if (!feedback || typeof feedback !== "string") {
      return res.status(400).json({ error: "Thiáº¿u ná»™i dung pháº£n há»“i." });
    }

    await feedbackService.saveFeedback({
      questionId: questionId || null,
      rating: feedback.trim(),
      note: note || null,
      userIp,
    });

    console.log(`[feedback] âœ… Saved feedback (${userIp})`);
    return res.status(200).json({ message: "âœ… Cáº£m Æ¡n pháº£n há»“i cá»§a báº¡n ðŸ’¬", saved: true });
  } catch (err) {
    console.error("[feedback] ðŸ’¥ Lá»—i ghi nháº­n pháº£n há»“i:", err.message);
    res.status(500).json({ error: "KhÃ´ng thá»ƒ lÆ°u pháº£n há»“i." });
  }
}

